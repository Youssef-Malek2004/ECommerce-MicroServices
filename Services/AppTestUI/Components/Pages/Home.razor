@page "/"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using System.Text.Json
@using Shared.Contracts.Entities.NotificationService

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

Messages from the server 👇

<ul>
    @foreach (var notification in _notifications)
    {
        <li>
            <strong>@notification.Title:</strong> @notification.Message
            <button @onclick="() => MarkNotificationAsRead(notification.Id)">Mark as Read</button>
        </li>   
    }
</ul>

@code
{
    private HubConnection? _hubConnection;
    private readonly List<Notification> _notifications = new();
    private bool _isRendering;

    protected override async Task OnInitializedAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl("http://localhost:5279/chat-hub",
                o => o.AccessTokenProvider = () => Task.FromResult<string?>("eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwM2RjZTU3Zi1iMmIyLTQ2NDgtYjQ4Zi00YjAwMTdmYWM1ODQiLCJlbWFpbCI6InlvdXNzZWZtYWxla3ZlbmRvckBnbWFpbC5jb20iLCJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dzLzIwMDgvMDYvaWRlbnRpdHkvY2xhaW1zL3JvbGUiOlsiUmVnaXN0ZXJlZCIsIlZlbmRvciJdLCJQZXJtaXNzaW9ucyI6WyJSZWFkVXNlcnMiLCJVcGRhdGVVc2VycyIsIk11c3RCZVNhbWVVc2VyIl0sImV4cCI6MTczMzc5MTE0NCwiaXNzIjoiRWNvbW1lcmNlLlVzZXJTZXJ2aWNlIiwiYXVkIjoiRWNvbW1lcmNlLlVzZXJzIn0.LJxU22ms_vVFVYnRpdhqPSV7YawU9lfoLsFa4SvOxN6SiLDUCNdC6CeZWk4ulheJjfhjtst2syvyE9Cx1pVE5FOYHkk89I902WXTlXqJKJ3NTzRH9_LiYAcfeFxUTl8Jz9jYPcndsbODbJNPZVkqHk0bOfZgtB691YkKNjb-J-2hRkEcsQnW7QANzzQNGZybDHI5jfHYh-2PyLG_l-bjTN-SeYDi0CNtuNez1yzF3lf3P_kdpq0ns_QttJtMT7zt50x16czVJvY0KbXvh0a45cfqV0o5bj_-x0QZSRtLuoA6ifyqkSaofNvqnoifLrg6LC-7RsrFetmJkfHgvUmMoQ"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<string>("ReceiveNotification", message =>
        {
            try
            {
                var notification = JsonSerializer.Deserialize<Notification>(message);
                if (notification == null) return;
                if (_notifications.All(n => n.Id != notification.Id))
                {
                    _notifications.Add(notification);

                    if (!_isRendering)
                    {
                        _isRendering = true;
                        InvokeAsync(StateHasChanged).ContinueWith(_ => _isRendering = false);
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error deserializing notification: {ex.Message}");
            }
        });

        try
        {
            await _hubConnection.StartAsync();
            Console.WriteLine("SignalR connection started.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting SignalR connection: {ex.Message}");
        }
    }
    
    private async Task MarkNotificationAsRead(Guid notificationId)
    {
        if (_hubConnection == null)
        {
            Console.WriteLine("SignalR connection is not established.");
            return;
        }

        try
        {
            await _hubConnection.InvokeAsync("MarkNotificationAsRead", notificationId);
            
            Console.WriteLine($"Marked notification {notificationId} as read.");
            
            // Optionally, mark the notification as read locally
            var notification = _notifications.FirstOrDefault(n => n.Id == notificationId);
            if (notification != null)
            {
                _notifications.Remove(notification);
                
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marking notification as read: {ex.Message}");
        }
    }
    
    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

}
